<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Catatan Kesehatan</title>
<style>
body{font-family:Arial;background:#f5f7fb}
.card{max-width:500px;margin:40px auto;background:#fff;padding:20px;border-radius:12px}
label{font-weight:bold}
input,textarea,select{width:100%;margin-bottom:10px;padding:8px}
button{padding:10px;border:none;border-radius:8px;background:#4f46e5;color:#fff;font-weight:bold}
button.loading{opacity:.7;pointer-events:none}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.alert{display:none;margin-top:10px;padding:8px;border-radius:8px;font-weight:bold}
.ok{background:#dcfce7;color:#065f46}
.err{background:#fee2e2;color:#7f1d1d}
</style>
</head>
<body>

<div class="card">
<h3>Catatan Kesehatan</h3>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

<form id="form" target="hidden_iframe" method="post">
<input type="hidden" name="act" value="save">

<label>Nama</label>
<select name="nama">
  <option>ABIEL</option>
  <option>PAPA</option>
  <option>MAMA</option>
</select>

<label>Tanggal</label>
<input type="date" name="tanggal" required>

<label>Sakit</label>
<textarea name="sakit"></textarea>

<label>Obat</label>
<textarea name="obat"></textarea>

<label>Periksa</label>
<textarea name="periksa"></textarea>

<button id="btn">ðŸ’¾ Simpan</button>
<div id="alert" class="alert"></div>
</form>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw3Wq8Kmk_2tItiHRO6Kv0p4QJ_V-YiWkMwYQU2RGHKhlnJNSfE0x_5RPy1xeN0CNnX/exec';
const form = document.getElementById('form');
const btn = document.getElementById('btn');
const alertBox = document.getElementById('alert');
const iframe = document.getElementById('hidden_iframe');

form.action = API_URL;

let confirmed = false;
let timeoutId;

form.addEventListener('submit', () => {
  confirmed = false;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Menyimpan...';
  alertBox.style.display = 'none';

  // timeout lebih panjang & lebih ramah
  timeoutId = setTimeout(() => {
    if (!confirmed) {
      btn.disabled = false;
      btn.innerHTML = 'ðŸ’¾ Simpan';
      alertBox.className = 'alert ok';
      alertBox.textContent = 'âš ï¸ Data kemungkinan sudah tersimpan (konfirmasi lambat)';
      alertBox.style.display = 'block';
    }
  }, 15000); // 15 detik
});

window.addEventListener('message', (e) => {
  if (!e.data || e.data.type !== 'saveResult') return;

  confirmed = true;
  clearTimeout(timeoutId);

  btn.disabled = false;
  btn.innerHTML = 'ðŸ’¾ Simpan';

  if (e.data.ok) {
    alertBox.className = 'alert ok';
    alertBox.textContent = 'âœ… Data berhasil disimpan';
    form.reset();
  } else {
    alertBox.className = 'alert err';
    alertBox.textContent = 'âŒ ' + (e.data.error || 'Gagal');
  }
  alertBox.style.display = 'block';
});

// fallback terakhir: iframe selesai load tapi postMessage tidak datang
iframe.addEventListener('load', () => {
  if (!confirmed) {
    confirmed = true;
    clearTimeout(timeoutId);
    btn.disabled = false;
    btn.innerHTML = 'ðŸ’¾ Simpan';
    alertBox.className = 'alert ok';
    alertBox.textContent = 'âœ… Data tersimpan';
    alertBox.style.display = 'block';
  }
});
return HtmlService.createHtmlOutput(
  '<script>parent.postMessage({type:"saveResult",ok:true},"*");</script>
);

</body>
</html>



