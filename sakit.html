<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Catatan Kesehatan Keluarga</title>

<style>
:root{ --bg:#f5f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --primary:#4f46e5; }
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:24px auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;border:1px solid var(--border)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.full{grid-column:1/-1}
label{font-weight:bold}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)}
textarea{min-height:80px}
button{padding:8px 12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-ghost{background:#f3f4f6;border:1px solid var(--border)}
.date-row{display:flex;gap:6px;margin-bottom:6px}
.date-row button{padding:6px 8px}
.spinner{width:14px;height:14px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.alert{display:none;margin-top:10px;padding:8px;border-radius:8px;font-weight:bold}
.ok{background:#dcfce7;color:#065f46}
.err{background:#fee2e2;color:#7f1d1d}

/* modal history */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center}
.modal.open{display:flex}
.sheet{background:#fff;width:min(100%,900px);max-height:80vh;overflow:auto;padding:12px;border-radius:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px;text-align:left;vertical-align:top}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

<form id="form" target="hidden_iframe" method="post">
<input type="hidden" name="act" value="save">

<div class="grid">
  <div class="full">
    <label>Nama</label>
    <div style="display:flex;gap:8px">
      <select id="nama" name="nama">
        <option>ABIEL</option>
        <option>PAPA</option>
        <option>MAMA</option>
      </select>
      <button type="button" id="btnHistory" class="btn-ghost">üìú History</button>
    </div>
  </div>

  <div class="full">
    <label>Tanggal (boleh lebih dari satu)</label>
    <div id="dates"></div>
    <button type="button" id="addDate" class="btn-ghost">‚ûï Tambah Tanggal</button>
    <input type="hidden" name="tanggal" id="tanggal">
  </div>
</div>

<div class="grid" style="margin-top:12px">
  <div class="full"><label>Sakit</label><textarea name="sakit"></textarea></div>
  <div class="full"><label>Obat</label><textarea name="obat"></textarea></div>
  <div class="full"><label>Periksa</label><textarea name="periksa"></textarea></div>
</div>

<button id="btnSave" class="btn-primary" style="margin-top:12px">üíæ Simpan</button>
<div id="alert" class="alert"></div>
</form>

</div>
</div>

<!-- MODAL HISTORY (tidak berubah) -->
<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <strong id="modalTitle">History</strong>
      <select id="yearFilter"></select>
      <button id="btnClose" class="btn-ghost">Tutup</button>
    </div>
    <div id="historyRoot"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbw3Wq8Kmk_2tItiHRO6Kv0p4QJ_V-YiWkMwYQU2RGHKhlnJNSfE0x_5RPy1xeN0CNnX/exec';
  /* ================= HISTORY ================= */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const historyRoot = document.getElementById('historyRoot');
const yearFilter = document.getElementById('yearFilter');
const btnClose = document.getElementById('btnClose');

function jsonp(url){
  return new Promise((res,rej)=>{
    const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    window[cb]=(d)=>{delete window[cb];s.remove();res(d)};
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>rej(new Error('JSONP error'));
    document.body.appendChild(s);
  });
}

let allRows = [];

document.getElementById('btnHistory').onclick = async () => {
  const nama = document.getElementById('nama').value;
  modal.classList.add('open');
  modalTitle.textContent = 'History: ' + nama;
  historyRoot.textContent = 'Memuat data...';

  try {
    const j = await jsonp(
      API_URL + '?act=history&nama=' + encodeURIComponent(nama)
    );
    allRows = j.data || [];
    buildYearFilter(allRows);
    renderHistory();
  } catch (e) {
    historyRoot.textContent = 'Gagal memuat history';
  }
};

btnClose.onclick = () => modal.classList.remove('open');
yearFilter.onchange = renderHistory;

function fmtDate(val){
  if(!val) return '';
  const d = new Date(val);
  if(isNaN(d)) return val;
  return d.getFullYear() + '-' +
    String(d.getMonth()+1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

function buildYearFilter(rows){
  const years = new Set();
  rows.forEach(r=>{
    const d=new Date(r.Tanggal || r.Timestamp);
    if(!isNaN(d)) years.add(d.getFullYear());
  });
  const list=[...years].sort((a,b)=>b-a);
  yearFilter.innerHTML =
    '<option value="all">Semua Tahun</option>' +
    list.map(y=>`<option value="${y}">${y}</option>`).join('');
}

function renderHistory(){
  let rows=[...allRows];
  const y=yearFilter.value;

  if(y!=='all'){
    rows=rows.filter(r=>{
      const d=new Date(r.Tanggal||r.Timestamp);
      return !isNaN(d)&&d.getFullYear()==y;
    });
  }

  rows.sort((a,b)=>{
    const da=new Date(a.Tanggal||a.Timestamp||0);
    const db=new Date(b.Tanggal||b.Timestamp||0);
    return db-da;
  });

  if(!rows.length){
    historyRoot.textContent='Belum ada data';
    return;
  }

  let html='<table class="table"><tr>' +
           '<th>Tanggal</th><th>Sakit</th><th>Obat</th><th>Periksa</th></tr>';

  rows.forEach(r=>{
    html+=`
      <tr>
        <td>${fmtDate(r.Tanggal)}</td>
        <td>${r.Sakit||''}</td>
        <td>${r.Obat||''}</td>
        <td>${r.Periksa||''}</td>
      </tr>`;
  });

  historyRoot.innerHTML = html + '</table>';
}


/* ================= MULTI DATE ================= */
const datesBox=document.getElementById('dates');
const hiddenTanggal=document.getElementById('tanggal');

function addDate(val=''){
  const row=document.createElement('div');
  row.className='date-row';
  row.innerHTML=`
    <input type="date" value="${val}">
    <button type="button">‚ùå</button>
  `;
  row.querySelector('button').onclick=()=>row.remove();
  datesBox.appendChild(row);
}

document.getElementById('addDate').onclick=()=>addDate();

// default 1 tanggal hari ini
addDate(new Date().toISOString().slice(0,10));

/* ================= SUBMIT ================= */
const form=document.getElementById('form');
const btn=document.getElementById('btnSave');
const alertBox=document.getElementById('alert');
const iframe=document.getElementById('hidden_iframe');

form.action=API_URL;

let confirmed=false, timeoutId;

form.addEventListener('submit',()=>{
  // gabungkan tanggal
  const vals=[...datesBox.querySelectorAll('input')]
    .map(i=>i.value).filter(Boolean);
  hiddenTanggal.value=vals.join(',');

  confirmed=false;
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span>Menyimpan...';
  alertBox.style.display='none';

  timeoutId=setTimeout(()=>{
    if(!confirmed){
      resetBtn();
      showOk('‚ö†Ô∏è Data kemungkinan sudah tersimpan');
    }
  },15000);
});

window.addEventListener('message',(e)=>{
  if(!e.data||e.data.type!=='saveResult')return;
  confirmed=true; clearTimeout(timeoutId);
  resetBtn();
  e.data.ok ? showOk('‚úÖ Data berhasil disimpan') : showErr(e.data.error||'Gagal');
  if(e.data.ok) form.reset(), datesBox.innerHTML='', addDate(new Date().toISOString().slice(0,10));
});

iframe.addEventListener('load',()=>{
  if(!confirmed){
    confirmed=true; clearTimeout(timeoutId);
    resetBtn(); showOk('‚úÖ Data tersimpan');
  }
});

function resetBtn(){btn.disabled=false;btn.innerHTML='üíæ Simpan'}
function showOk(m){alertBox.className='alert ok';alertBox.textContent=m;alertBox.style.display='block'}
function showErr(m){alertBox.className='alert err';alertBox.textContent=m;alertBox.style.display='block'}
</script>
</body>
</html>

