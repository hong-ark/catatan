<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabel Belanja Bulanan</title>

<style>
body { font-family: system-ui; background: #f8fafc; padding: 14px; }
h1 { text-align: center; }
h2 { margin-top: 22px; }

table {
  width: 100%; border-collapse: collapse; background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,.06);
}
th, td {
  padding: 8px; font-size: 13px; text-align: center;
  border-bottom: 1px solid #e5e7eb;
}
th { background: #f1f5f9; }
td.name { text-align: left; font-weight: 600; }
.buy { color: #dc2626; font-weight: 700; }
tr.done { opacity: .45; text-decoration: line-through; }

button {
  width: 100%; margin: 6px 0; padding: 8px;
  border: none; border-radius: 8px; cursor: pointer;
}
.btn-add { background: #16a34a; color: white; }
.btn-manage { background: #2563eb; color: white; }
</style>
</head>

<body>

<h1>üõí Tabel Belanja Bulanan</h1>
<div id="content">Memuat...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzpOLfTD8fo5u6rQZRI2EQ9LVauEWH_sgCXtVP56t9gL1mR2AKeZm4rpZwMVQSOUWVetw/exec";

fetch(API_URL).then(r => r.json()).then(render);

function render(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";

  const categories = [...new Set(data.map(i => i.KATEGORI))];

  categories.forEach(cat => {
    let rows = "";
    const items = data.filter(i => i.KATEGORI === cat && (i.AKTIF === true || i.AKTIF === "TRUE"));

    items.forEach(i => {
      const beli = Math.max(i["STOCK TARGET"] - i["STOCK TERSEDIA"], 0);
      if (beli <= 0) return;

      rows += `
        <tr>
          <td class="name">${i["NAMA BARANG"]}</td>
          <td class="buy">${beli} ${i.SATUAN || ""}</td>
          <td>${i["STOCK TERSEDIA"]}</td>
          <td>${i["STOCK TARGET"]}</td>
        </tr>`;
    });

    if (rows) {
      content.innerHTML += `
        <h2>${cat}</h2>
        <table>
          <tr><th>Barang</th><th>Pembelian</th><th>Stok</th><th>Target</th></tr>
          ${rows}
        </table>
        <button class="btn-add" onclick="addItem('${cat}')">‚ûï Tambah Barang</button>
        <button class="btn-manage" onclick="manageItems('${cat}')">‚öôÔ∏è Kelola Barang</button>
      `;
    }
  });
}

function addItem(cat) {
  const nama = prompt("Nama barang:");
  if (!nama) return;

  const target = prompt("Target stok:", "1");
  const satuan = prompt("Satuan (pcs/kg/liter):", "pcs");

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      KATEGORI: cat,
      "NAMA BARANG": nama,
      "STOCK TERSEDIA": 0,
      "STOCK TARGET": target,
      SATUAN: satuan
    })
  }).then(() => location.reload());
}

function manageItems(cat) {
  fetch(API_URL).then(r => r.json()).then(data => {
    const items = data.filter(i => i.KATEGORI === cat && (i.AKTIF === true || i.AKTIF === "TRUE"));
    let text = "Edit / hapus barang:\n\n";
    items.forEach(i => text += `${i["NAMA BARANG"]} = ${i["STOCK TERSEDIA"]}\n`);

    const res = prompt(text + "\n(Hapus: ketik 0)");
    if (!res) return;

    res.split("\n").forEach(line => {
      const [nama, val] = line.split("=").map(s => s.trim());
      if (!nama) return;

      if (val === "0") {
        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ nama, action: "remove" })
        });
      } else if (!isNaN(val)) {
        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ nama, stock: val })
        });
      }
    });

    setTimeout(() => location.reload(), 600);
  });
}
</script>

</body>
</html>
