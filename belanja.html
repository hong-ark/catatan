<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabel Belanja Bulanan</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f8fafc;
  margin: 0;
  padding: 14px;
}

h1 { text-align: center; margin-bottom: 12px; }
h2 { margin-top: 22px; font-size: 16px; color: #334155; }

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  margin-bottom: 6px;
}

th, td {
  padding: 8px 6px;
  font-size: 13px;
  text-align: center;
  border-bottom: 1px solid #e5e7eb;
}

th { background: #f1f5f9; font-weight: 600; }
td.name { text-align: left; font-weight: 600; }

.buy { font-weight: 700; color: #dc2626; }
.buy.zero { color: #64748b; font-weight: 500; }

tr.done {
  opacity: 0.45;
  text-decoration: line-through;
}

input[type="checkbox"] {
  transform: scale(1.3);
}

input[type="checkbox"]:disabled {
  opacity: 0.3;
}

.actions {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}

.btn-add { background: #16a34a; color: white; }
.btn-edit { background: #2563eb; color: white; }

.btn-export {
  background: #25D366;
  color: white;
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 14px;
  font-size: 15px;
  border: none;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>üõí Tabel Belanja Bulanan</h1>

<button class="btn-export" onclick="exportWhatsApp()">üì§ Kirim ke WhatsApp</button>

<div id="content">Memuat data...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbww6-U__YRTcd0g-QTSeA8A07k5Y4vmGxl-oAtfNPyj0POlf0yyS9GfXvSCzCj42xJ_Xg/exec";

fetch(API_URL).then(r => r.json()).then(render);

function render(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";

  const categories = [...new Set(data.map(i => i.KATEGORI))];

  categories.forEach(cat => {
    let rows = "";
    const items = data.filter(i =>
      i.KATEGORI === cat &&
      (i.AKTIF === true || i.AKTIF === "TRUE")
    );

    items.forEach(item => {
      const stock = Number(item["STOCK TERSEDIA"]);
      const target = Number(item["STOCK TARGET"]);
      const beli = Math.max(target - stock, 0);
      const satuan = item.SATUAN || "";
      const checked = item.DIBELI === true || item.DIBELI === "TRUE";

      rows += `
        <tr class="${checked && beli > 0 ? "done" : ""}">
          <td class="name">${item["NAMA BARANG"]}</td>
          <td class="buy ${beli === 0 ? "zero" : ""}">
            ${beli} ${satuan}
          </td>
          <td>${stock}</td>
          <td>${target}</td>
          <td>
            <input type="checkbox"
              ${beli === 0 ? "disabled" : ""}
              ${checked && beli > 0 ? "checked" : ""}
              onchange="toggleCheck('${item["NAMA BARANG"]}', this.checked, this)">
          </td>
        </tr>
      `;
    });

    if (rows) {
      content.innerHTML += `
        <h2>${cat}</h2>
        <table>
          <thead>
            <tr>
              <th>Barang</th>
              <th>Pembelian</th>
              <th>Stok</th>
              <th>Target</th>
              <th>‚úî</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>

        <div class="actions">
          <button class="btn-add" onclick="addItem('${cat}')">‚ûï Tambah Barang</button>
          <button class="btn-edit" onclick="editStock('${cat}')">‚úèÔ∏è Edit Stok</button>
        </div>
      `;
    }
  });
}

function toggleCheck(nama, checked, el) {
  if (el.disabled) return;
  el.closest("tr").classList.toggle("done", checked);

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ nama, dibeli: checked })
  });
}

function exportWhatsApp() {
  let text = "üõí DAFTAR BELANJA BULANAN\n\n";
  document.querySelectorAll("tbody tr").forEach(row => {
    const checkbox = row.querySelector("input[type='checkbox']");
    if (checkbox && !checkbox.disabled && !checkbox.checked) {
      const cols = row.querySelectorAll("td");
      text += `‚Ä¢ ${cols[0].innerText} ‚Äì ${cols[1].innerText}\n`;
    }
  });

  if (text.trim() === "") {
    alert("Semua barang sudah dibeli üëç");
    return;
  }

  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
}
</script>

</body>
</html>
